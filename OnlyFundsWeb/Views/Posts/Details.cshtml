@model BusinessObjects.Post
@using BusinessObjects
@using DataAccess.IRepository
@using DataAccess.Repository
@using Microsoft.AspNetCore.Http


@{
    ViewData["Title"] = "Details";
    Layout = "~/Views/Shared/_userLayout.cshtml";
    bool isAdmin = ViewBag.IsAdmin;
    IEnumerable<PostReport> reports = ViewBag.Reports as IEnumerable<PostReport>;
    IEnumerable<Comment> comments = ViewBag.Comments;
    IEnumerable<User> cmtUsers = ViewBag.CmtUsers;
    //if user is not admin
    //check if the user has reported that post
    //use _userLayout
    bool reported = false;
    User currentUser = ViewBag.CurrentUser;
    bool isSolved = false;
    if (isAdmin == false)
    {
        Layout = "~/Views/Shared/_userLayout.cshtml";
        foreach (var report in reports)
        {
            if (report.ReporterUsername.Equals(currentUser.Username))
            {
                reported = true;
                break;
            }
        }
    }
    else
    {
        //check if the post has any reports
        //if true, check if the report has been solved
        //if false, show 3 buttons: warn user, delete post and do nothing
        if (reports.Count() > 0)
        {
            foreach (var report in reports)
            {
                if (report.IsSolved == true)
                {
                    isSolved = true;
                    break;
                }
            }
        }

    }

}

<head>
    <link rel="stylesheet" href="~/css/post_detail.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

</head>
<!-- Main Content -->
<main class="mt-3">
    <h1>@isAdmin</h1>
    <div class="container w-75 pt-3">
        <h3 class="text-center">@Model.PostTitle</h3>
        <div class="row">
            <div class="col ps-0 fw-bold" style="font-size: 17px;">
                @Model.UploadDate.Value.ToString("dd-MMM-yyyy")
            </div>

            <div>
                @{
                    bool IsBookmarked = (bool)ViewBag.IsBookmarked;
                    <div>@IsBookmarked</div>
                    if (!IsBookmarked)
                    {
                        @Html.ActionLink("Add Bookmark", "AddBookMark", "BookMark", new { username = currentUser.Username, postId = Model.PostId })

                    }
                    else
                    {
                        @Html.ActionLink("Remove Bookmark", "RemoveBookMark", "BookMark", new { username = currentUser.Username, postId = Model.PostId })
                    }
                }
            </div>

            <!---->

        </div>
        <div class="row border border-dark rounded p-3 mb-5">
            <div class="col-12 pb-3 text-break" id="post-content">
                @Model.PostDescription
            </div>
            @{
                if (!string.IsNullOrEmpty(Model.FileUrl))
                {
                    <div class="col-12 pb-3">
                        <i class="fas fa-paperclip" style="transform: scale(0.8);"></i>
                        <a href="~/postfiles/@Model.FileUrl" class="add-on"
                           style="font-size: 17px; color: red; text-decoration: underline;">@Model.FileUrl</a>
                    </div>
                }
            }
            <div class="col-12 pb-2 border-bottom" style="position: relative;" id="icon-bar">
                <!-- if user is not admin: show like button -->
                @{
                    if (isAdmin == false)
                    {
                        <!-- Like button, đếm số like của 1 post -->
                        <a href="#AJAX" class="like me-4">
                            <i class="far fa-thumbs-up"></i>
                            421
                            <!-- Đã like thì chuyển thành nút này -->
                            <!-- <i class="fas fa-thumbs-up"></i> -->
                        </a>
                    }
                }
                <!-- Đếm số comment của post -->
                <a href="#AJAX" class="comment">
                    <i class="fas fa-comment">@comments.Count()</i>
                </a>
                <text>
                    <!-- Nếu User không phải là isAdmin -->
                    @{
                        if (isAdmin == false)
                        {
                            //nếu user không phải author
                            //check report
                            //nếu chưa có report của user và post đó
                            //hiện nút report
                            //else: báo "you have reported this post"
                            if (!Model.UploaderUsername.Equals(currentUser.Username))
                            {
                                if (reported == false)
                                {
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#report-modal" class="report"
                                       style="position: absolute; right: 0;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </a>
                                    <div class="modal fade" id="report-modal" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Report post</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <form asp-action="Add" asp-controller="Report" method="Post"
                                                          asp-route-postid="@Model.PostId" id="report-form">
                                                        <div>
                                                            <label for="desc">Description</label>
                                                            <input type="text" name="desc" class="form-control" />
                                                        </div>
                                                    </form>
                                                </div>
                                                <div class="modal-footer">
                                                    <input type="submit" form="report-form" class="btn btn-primary" value="Submit" />
                                                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-danger">
                                        You have already reported this post
                                    </span>
                                }
                            }
                            //Nếu user là author của post: Hiện nút Edit và Delete
                            else
                            {
                                //Xoá post
                                <a href="#" class="me-4" data-bs-toggle="modal" data-bs-target="#modal-delete"
                                   style="position: absolute; right: 0;">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                                //Sửa post
                                <a asp-controller="Posts" asp-action="Edit" asp-route-id="@Model.PostId" style="position: absolute; right: 0;">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                                <div class="modal fade" id="modal-delete" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Delete Post</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <h5>This action will delete: </h5>
                                                <ul>
                                                    <li>All information of this post</li>
                                                    <li>Comments of this post</li>
                                                    <li>Likes of this post</li>
                                                </ul>
                                                <p class="text-danger">Are you sure you want to delete this post</p>
                                            </div>
                                            <div class="modal-footer">
                                                <form class="form-inline" asp-action="Delete" method="post"
                                                      asp-route-id="@Model.PostId">
                                                    <input type="submit" class="btn btn-danger" value="Delete" />
                                                    <button class="btn btn-secondary" data-bs-dismiss="modal"
                                                            aria-label="Close">
                                                        Cancel
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    }
                </text>
            </div>
            <!-- Nếu user không là isAdmin: Hiện form comment -->
            <!-- Write a comment -->
            @{
                if (isAdmin == false)
                {
                    <div class="comment-input mt-3">
                        <div class="comment-ava">
                            <img src="~/images/@currentUser.AvatarUrl" alt="avatar">
                        </div>
                        <div class="comment-text">
                            <form asp-action="Add" asp-controller="Comment" method="post">
                                <input type="hidden" name="postid" value="@Model.PostId" />
                                <input class="rounded-pill ps-2" type="text" placeholder="Write a comment..." name="content">
                            </form>
                        </div>
                    </div>
                }
            }
            <!-- List of comments-->
            <div class="comment-list">
                @{
                    foreach (Comment cmt in comments)
                    {
                        <div class="comment">
                            <div class="comment-ava">
                                @{
                                    foreach (User user in cmtUsers)
                                    {
                                        if (user.Username.Equals(cmt.Username))
                                        {
                                            <img src="~/images/@user.AvatarUrl" alt="@user.Username-avatar" />
                                            break;
                                        }
                                    }
                                }
                            </div>
                            <div class="comment-body">
                                <div class="main-content border rounded p-2 pt-1">
                                    <!-- Comment's author'-->
                                    <a class="bg-info fw-bold" asp-action="DetailsUser" asp-controller="User" asp-route-username="@cmt.Username">@cmt.Username</a>
                                    <!-- If user is not isAdmin and user is the author of the comment: Show edit and delete button-->
                                    @{
                                        if (isAdmin == false)
                                        {
                                            if (cmt.Username.Equals(currentUser.Username))
                                            {
                                                <!-- Edit Comment -->
                                                <a href="#" data-bs-toggle="modal" data-bs-target="#modalEdit-@cmt.CommentId">Edit</a>
                                                <div class="modal fade" id="modalEdit-@cmt.CommentId" tabindex="-1">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title">Edit</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <form asp-action="Edit" asp-controller="Comment" method="Post" asp-route-id="@cmt.CommentId" id="form-@cmt.CommentId" asp-route-postid="@Model.PostId">
                                                                    <textarea name="newContent" class="form-control" style="resize:none">@cmt.Content</textarea>
                                                                </form>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <input type="submit" form="form-@cmt.CommentId" class="btn btn-primary" value="Edit" />
                                                                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Delete Comment-->
                                                <a href="#" data-bs-toggle="modal" data-bs-target="#modal-@cmt.CommentId">Delete</a>
                                                <div class="modal fade" id="modal-@cmt.CommentId" tabindex="-1">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title">Delete Comment</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                Are you sure you want to delete this comment ?
                                                            </div>
                                                            <div class="modal-footer">
                                                                <form class="form-inline" asp-action="Delete" asp-controller="Comment" method="post" asp-route-id="@cmt.CommentId" asp-route-postid="@Model.PostId">
                                                                    <input type="submit" class="btn btn-danger" value="Delete" />
                                                                    <button class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        }
                                    }
                                    <!-- Comment's Content-->
                                    <p class="mb-0 text-break overflow-auto">
                                        @cmt.Content
                                    </p>
                                </div>
                                <!-- If user is not isAdmin: Show like button-->
                                @if (isAdmin == false)
                                {
                                    <!-- Icons -->
                                    <ul class="p-0">
                                        <li>
                                            <a href="#AJAX" class="like">
                                                <i class="far fa-thumbs-up"></i>
                                                421
                                                <!-- Đã like thì chuyển thành nút này -->
                                                <!-- <i class="fas fa-thumbs-up"></i> -->
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#AJAX" class="report">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </a>
                                        </li>
                                    </ul>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</main>
<!-- BookMark -->
<script defer>
    function clickBookmarkBtn(username,  postId) {
        alert("here");
        var btnBookmark = document.querySelector("#btnBookmark");
        if (btnBookmark.innerHTML === "Add Bookmark") {
            //Change button from add Book mark to
            //change this code
            btnBookmark.innerHTML = "Remove Bookmark";
            //Call action Bookmark/AddBookmark
            $.ajax({
                type: "GET",
                url: "Bookmark/AddBookmark",
                data: {
                    username: username,
                    postId: postId
                },
                cache: false,
                success: function () {
                    alert('success');
                }
            });
        }
        else {
            //Change button from add Book mark to
            //change this code
            btnBookmark.innerHTML = "Remove Bookmark";
            //Call action Bookmark/RemoveBookmark
            $.ajax({
                type: "GET",
                url: "Bookmark/RemoveBookmark",
                data: {
                    username: username,
                    postId: postId
                },
                cache: false,
                success: function () {
                    alert('success');
                }
            });
        }
    }
</script>

