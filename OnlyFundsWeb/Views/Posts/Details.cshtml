@model BusinessObjects.Post
@using BusinessObjects
@using DataAccess.IRepository
@using DataAccess.Repository
@using Microsoft.AspNetCore.Http

@{
    ViewData["Title"] = "Details";
    string username = Context.Session.GetString("user");
    string admin = Context.Session.GetString("admin");
    if (admin != null)
    {
        Layout = "_adminLayout";
    }
    else
    {
        Layout = "~/Views/Shared/_userLayout.cshtml";
    }
    IEnumerable<Comment> comments = ViewBag.Comments as IEnumerable<Comment>;
    IEnumerable<User> cmtUsers = ViewBag.CmtUsers as IEnumerable<User>;
    int postLike = ViewBag.PostLike;
    int postComment = ViewBag.PostComment;
    User CurrentUser = ViewBag.CurrentUser;
    bool reported = false;
    if (CurrentUser != null && !CurrentUser.Equals(Model.UploaderUsername))
    {
        IEnumerable<PostReport> reports = ViewBag.Reports as IEnumerable<PostReport>;
        foreach (var report in reports)
        {
            if (report.ReporterUsername.Equals(CurrentUser.Username))
            {
                reported = true;
                break;
            }
        }
    }
}

<head>
    <link rel="stylesheet" href="~/css/post_detail.css" />
</head>
<!-- Main content -->
<main class="mt-3">
    <div class="container w-75 pt-3">
        <h3 class="text-center">@Model.PostTitle</h3>

        <div class="row">
            <!-- Date here -->
            <div class="col ps-0 fw-bold" style="font-size: 17px;">
                @Model.UploadDate.Value.ToString("dd-MMM-yyyy")
            </div>
        </div>
        <div class="row border border-dark rounded p-3 mb-5">
            <div class="col-12 pb-3 text-break" id="post-content">
                @Model.PostDescription
            </div>
            @{
                if (!string.IsNullOrEmpty(Model.FileUrl))
                {
                    <div class="col-12 pb-3">
                        <i class="fas fa-paperclip" style="transform: scale(0.8);"></i>
                        <a href="~/postfiles/@Model.FileUrl" class="add-on"
                           style="font-size: 17px; color: red; text-decoration: underline;">@Model.FileUrl</a>
                    </div>
                }
        <div class="col-12 pb-2 border-bottom" style="position: relative;" id="icon-bar">
            <!-- Like button, đếm số like của 1 post -->

            <a asp-controller="PostLike" asp-action="AddLike" asp-route-username="@username" asp-route-postId="@Model.PostId" class="like me-4">
                <i class="far fa-thumbs-up"></i>
                @ViewBag.PostLike
                <!-- Đã like thì chuyển thành nút này -->
                <!-- <i class="fas fa-thumbs-up"></i> -->
            </a>
            <!-- Đếm số comment của post -->
            <span class="post-comment">
                <i class="fas fa-comment"></i>
                @ViewBag.PostComment
            </span>
            <!-- Nếu user không phải author -->
            @{
                if (CurrentUser != null)
                {
                    if (!Model.UploaderUsername.Equals(CurrentUser.Username))
                    {
                        if (reported == false)
                        {
                            <a href="#" data-bs-toggle="modal" data-bs-target="#report-form" class="report float-end">
                                <i class="fas fa-exclamation-triangle"></i>
                            </a>
                            <div class="modal fade" id="report-form" tabindex="-1">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Report post</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form asp-action="Add" asp-controller="Report" method="Post"
                                                  asp-route-postid="@Model.PostId" id="report-form">
                                                <div>
                                                    <label for="desc">Description</label>
                                                    <textarea name="desc" placeholder="Please tell us your problem..."
                                                              class="form-control" style="height: 10rem;"></textarea>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="modal-footer">
                                            <input type="submit" form="report-form" class="btn btn-primary" value="Submit" />
                                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <span href="#" data-bs-toggle="tooltip" data-bs-placement="top"
                                  title="You have already reported this post" onclick="return false" class="float-end" style="cursor: default">
                                <i class="fas fa-exclamation-triangle"></i>
                            </span>
                        }
                        <a href="#Bookmark" class="bookmark me-4 float-end">
                            <i class="far fa-bookmark"></i>
                            <!-- Đã bookmark thì chuyển thành nút này -->
                            <!-- <i class="fas fa-thumbs-up"></i> -->
                        </a>

                    }
                    else
                    {
                        <!-- Xoá post-->
                        <a href="#" class="me-4" data-bs-toggle="modal" data-bs-target="#modal-delete"
                           style="position: absolute; right: 0;">
                            <i class="fas fa-trash-alt"></i>
                        </a>
                        <!-- Sửa post-->
                        <a asp-controller="Posts" asp-action="Edit" asp-route-id="@Model.PostId" style="position: absolute; right: 0;">
                            <i class="fas fa-pencil-alt"></i>
                        </a>
                        <div class="modal fade" id="modal-delete" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Delete Post</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <h5>This action will delete: </h5>
                                        <ul>
                                            <li>All information of this post</li>
                                            <li>Comments of this post</li>
                                            <li>Likes of this post</li>
                                        </ul>
                                        <p class="text-danger">Are you sure you want to delete this post</p>
                                    </div>
                                    <div class="modal-footer">
                                        <form class="form-inline" asp-action="Delete" method="post"
                                              asp-route-id="@Model.PostId">
                                            <input type="submit" class="btn btn-danger" value="Delete" />
                                            <button class="btn btn-secondary" data-bs-dismiss="modal"
                                                    aria-label="Close">
                                                Cancel
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
            }
        </div>
                <!-- Write a comment -->
                if (admin == null && username != null)
                {
                    <div class="comment-input mt-3 mt-3">
                        <div class="comment-ava">
                            <img src="blalbla ble ble" />
                            @*<img src="~/images/@user.AvatarUrl" alt="">*@
                        </div>
                        <div class="comment-text">
                            <form asp-route-postid="@Model.PostId" asp-action="Add" asp-controller="Comment" method="post">
                                <input class="rounded-pill ps-2" type="text" placeholder="Write a comment..." name="content"
                                       id="content">
                                <button type="submit" class="btn btn-sm rounded-pill btn-warning">Post</button>
                            </form>
                        </div>
                    </div>
                }
                <!-- List of comments -->
                <div class="comment-list">
                    @{
                        foreach (Comment cmt in comments)
                        {
                            <div class="comment mb-3">
                                <div class="comment-ava">
                                    @{
                                        foreach (User user in cmtUsers)
                                        {
                                            if (user.Username.Equals(cmt.Username))
                                            {
                                                <img src="~/images/@user.AvatarUrl" alt="@user.Username-avatar" />
                                                break;
                                            }
                                        }
                                    }
                                </div>
                                <div class="comment-body">
                                    <div class="main-content border rounded p-2 pt-1">
                                        <!-- Comment's author -->
                                        <div class="comment-name pb-1 border-bottom">
                                            <a href="#author-page" class="info fw-bold" id="author-link">@cmt.Username</a>
                                            <span> commented on @cmt.CommentDate.Value.ToString("dd-MMM-yyyy")</span>
                                        </div>
                                        <!-- Comment's content -->
                                        <p class="mb-0">
                                            @cmt.Content
                                        </p>
                                    </div>
                                    <!-- Icons -->
                                    <ul class="p-0">
                                        <li>
                                            <a asp-action="AddCommentLike" asp-controller="CommentLike" asp-route-postId="@Model.PostId" asp-route-username="@username" asp-route-commentId="@cmt.CommentId" class="like">
                                                <i class="far fa-thumbs-up"></i>
                                                @cmt.CommentLikes.Count
                                                <!-- Đã like thì chuyển thành nút này -->
                                                <!-- <i class="fas fa-thumbs-up"></i> -->
                                            </a>
                                        </li>
                                        @{
                                            if (CurrentUser != null && cmt.Username.Equals(CurrentUser.Username))
                                            {
                                                <li>
                                                    <a href="#" data-bs-toggle="modal" data-bs-target="#modalEdit-@cmt.CommentId">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <div class="modal fade" id="modalEdit-@cmt.CommentId" tabindex="-1">
                                                        <div class="modal-dialog modal-dialog-centered">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Edit</h5>
                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                                            aria-label="Close"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form asp-action="Edit" asp-controller="Comment" method="Post"
                                                                          asp-route-id="@cmt.CommentId" id="form-@cmt.CommentId"
                                                                          asp-route-postid="@Model.PostId">
                                                                        <textarea name="newContent" class="form-control"
                                                                                  style="resize:none">@cmt.Content</textarea>
                                                                    </form>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <input type="submit" form="form-@cmt.CommentId"
                                                                           class="btn btn-primary" value="Edit" />
                                                                    <button class="btn btn-secondary"
                                                                            data-bs-dismiss="modal">
                                                                        Cancel
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>
                                                <li>
                                                    <a href="#" data-bs-toggle="modal" data-bs-target="#modal-@cmt.CommentId">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </a>
                                                    <div class="modal fade" id="modal-@cmt.CommentId" tabindex="-1">
                                                        <div class="modal-dialog modal-dialog-centered">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Delete Comment</h5>
                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    Are you sure you want to delete this comment ?
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <form class="form-inline" asp-action="Delete" asp-controller="Comment" method="post" asp-route-id="@cmt.CommentId" asp-route-postid="@Model.PostId">
                                                                        <input type="submit" class="btn btn-danger" value="Delete" />
                                                                        <button class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>
                                            }
                                        }
                                    </ul>
                                </div>
                                <div class="line"></div>
                            </div>
                        }
                    }
                    <!--End of comment list-->
                </div>
            }
        </div>
    </div>
</main>
<!-- JavaScript Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>
<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

</script>
